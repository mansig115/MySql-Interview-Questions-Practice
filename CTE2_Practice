-- EASY LEVEL

-- Average marks per student
-- ðŸ‘‰ Create a CTE to calculate average marks of each student, then JOIN with students to show student name and average marks.
With CTE as (Select s.student_id, s.name, avg(m.marks) as avg_marks from  students s join marks m  on m.student_id = s.student_id group by s.student_id, s.name)
Select * from CTE;

With avg_marks_cte as(Select student_id, avg(marks) as avg_marks from marks group by student_id)
Select s.student_id, s.name, a.avg_marks from students s join avg_marks_cte a on s.student_id = a.student_id;


-- Total marks per student
-- ðŸ‘‰ Use a CTE to calculate total marks, then JOIN to display student name and total marks.
With total_marks_cte as (Select student_id, sum(marks) as total_marks from marks group by student_id)
Select s.student_id, s.name, t.total_marks from students s join total_marks_cte t on s.student_id = t.student_id;

-- Subject-wise average marks
-- ðŸ‘‰ Create a CTE for subject-wise average marks and display subject and average.
With subject_avg_marks as(Select subject, avg(marks) as avg_marks from marks group by subject)
Select subject, avg_marks from subject_avg_marks;



-- ðŸŸ¡ MEDIUM LEVEL

-- Students scoring above their average
-- ðŸ‘‰ Create a CTE to calculate average marks per student, then JOIN it with marks to find subjects where the student scored above their own average.
With avg_marks_per_student as (Select student_id, round(avg(marks),2) as avg_marks from marks group by student_id)
Select m.student_id, m.subject, m.marks, a.avg_marks from marks m join avg_marks_per_student a on m.student_id = a.student_id where m.marks > a.avg_marks;


-- Students who failed in any subject (marks < 60)
-- ðŸ‘‰ Create a CTE to find students who scored below 60, then JOIN with students to display names.
With score_less_cte as(Select student_id, marks from marks where marks < 60)
Select s.student_id, s.name, sc.marks from students s join score_less_cte sc on s.student_id = sc.student_id;




-- ðŸ”´ HARD LEVEL

-- Rank students by average marks
-- ðŸ‘‰ Create a CTE to calculate average marks per student and assign ranks using RANK().
With student_rank as(Select student_id, avg(marks) as avg_marks, rank() over(order by avg(marks) desc) as rn  from marks group by student_id)
Select student_id, avg_marks, rn from student_rank;

-- Subjects where class average is above 75
-- ðŸ‘‰ Use a CTE to calculate subject-wise average, then filter subjects with avg > 75.
With subject_avg as(Select subject, avg(marks) as  avg_marks from marks group by subject)
Select * from subject_avg where avg_marks > 75;

-- Students who scored higher than subject average
-- ðŸ‘‰ Create a CTE to calculate subject average, then JOIN with marks to find students scoring above subject average.
With high_score as(Select subject, avg(marks) as avg_marks from marks group by subject)
Select m.student_id, m.subject, m.marks, h.avg_marks from marks m join high_score h on m.subject = h.subject where m.marks > h.avg_marks;

-- ðŸŸ¡ Question 1: Top Scorer per Subject

-- ðŸ‘‰ Create a CTE to rank students within each subject based on marks and display only the top scorer(s) per subject.

With top_scorer_student as(Select student_id, subject, marks, rank() over(partition by subject order by marks desc) as student_rank from marks)
Select student_id, subject, marks from top_scorer_student where student_rank = 1;



-- ðŸ”´ Question 2: Students Above Overall Class Average

-- ðŸ‘‰ Create a CTE to calculate the overall class average marks, then find students whose average marks are above the class average.

With class_avg_marks as (Select avg(marks) as overall_avg from marks),
student_avg_marks as (Select student_id, avg(marks) as student_avg from marks group by student_id)
Select s.student_id, s.student_avg from student_avg_marks s cross join class_avg_marks c where s.student_avg > c.overall_avg; 
